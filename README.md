# Thermal Simulation of Li-ion Cells for Electric Vehicles

This repository contains the modeling framework to investigate the thermal behavior of commercial 18650-format Lithium-ion cells (NCA and NMC). This study presents a coupled modeling framework to simulate battery thermal performance, which is critical for ensuring safe and efficient operation in applications like electric vehicles.

The methodology combines:

1.  **MATLAB:** To implement Shepherd's voltage model, simulating the battery's electrochemical state (SOC) and calculating time-dependent heat generation rates (Joule and entropy contributions).
2.  **C (UDF):** A User-Defined Function (UDF) written in C to read the heat generation data from MATLAB.
3.  **ANSYS Fluent:** A 3D finite volume simulation to model heat transfer and map temperature distributions within the cell, using the C-UDF as the volumetric heat source.

## Repository Contents

This repository includes:

  * **`*.m` files:** MATLAB scripts (e.g., `Lithium_ion_cell_test_with_contour_charging.m`) used to model battery charging/discharging and generate heat source data.
  * **`*.c` files:** The C source code for the ANSYS Fluent User-Defined Function (UDF) (e.g., `UDF_h_gen_NCA_1C.c`). This UDF reads the generated `.csv` file.
  * **`*.csv` files:** Example data files (e.g., `heat_generation_NCA.csv`) generated by the MATLAB scripts. These serve as the input for the UDF.
  * **`*.cas.h5 / *.msh` files:** (User to add) ANSYS Fluent case and mesh files containing the 3D geometry, material properties, and boundary condition setups.

## Methodology Workflow

The simulation is performed using a "one-way coupling" approach. First, the heat generation is calculated in MATLAB, and then this data is fed into ANSYS Fluent as a predefined source term.

### **Part 1: Heat Generation (MATLAB)**

The included MATLAB script (`Lithium_ion_cell_test_with_contour_charging.m`) models the charging profile (Constant Current - Constant Voltage, or CC-CV) of a battery pack.

1.  **Model:** It uses **Shepherd's model** to relate cell voltage, State of Charge (SOC), and current.
2.  **Heat Calculation:** It calculates the total volumetric heat generation ($Q_{gen}$) in $W/m^3$ using the standard heat generation equation:
    $$
    $$$$Q\_{gen} = Q\_{joule} + Q\_{entropy}
    $$
    $$$$Where:
      * **Joule (Irreversible) Heating:** $Q_{joule} = \frac{I^2 \cdot R_{internal}}{Volume}$
      * **Entropic (Reversible) Heating:** $Q_{entropy} = \frac{I \cdot T \cdot \Delta S}{F \cdot Volume}$
3.  **Output:** The script saves two files:
      * `heat_generation_[type].csv`: A two-column file with [Time (s), Heat Generation (W/m^3)].
      * `soc_vs_time_[type].csv`: A two-column file with [Time (s), SOC].

### **Part 2: 3D Thermal Simulation (ANSYS Fluent)**

The 3D thermal simulation is conducted in ANSYS Fluent to solve the energy conservation equation for the battery cell.

1.  **Governing Equation:**
    $$
    $$$$\\rho c \\frac{\\partial T}{\\partial t} = \\nabla \\cdot (k \\nabla T) + Q\_{gen}(t)
    $$
    $$$$Where:
      * $\rho$ = Density
      * $c$ = Specific Heat
      * $k$ = Thermal Conductivity
      * $Q_{gen}(t)$ = The volumetric heat source (from our MATLAB data)
2.  **UDF:** The term $Q_{gen}(t)$ is not constant. We use the C-UDF (`UDF_h_gen_NCA_1C.c`) to feed the time-dependent heat generation values from the `.csv` file into the simulation as a transient energy source.

## How to Use These Codes

Follow these steps to replicate the simulation:

### **Step 1: Prerequisites**

Ensure you have the following software installed:

  * **MATLAB**
  * **ANSYS Fluent 2020 R1** or newer
  * A compatible C compiler (e.g., **Visual Studio** with Desktop C++ development tools, correctly linked to ANSYS Fluent).

### **Step 2: Generate Heat Source Data (MATLAB)**

1.  Open a `*.m` script (e.g., `Lithium_ion_cell_test_with_contour_charging.m`) in MATLAB.
2.  Configure the battery parameters inside the script:
      * `C_rate` (e.g., `0.5`, `1`, `2`)
      * `T_ambient` (e.g., `27` Â°C)
      * Pack configuration (`Ns`, `Np`)
3.  Run the script. This will create the necessary `.csv` files (e.g., `heat_generation_NCA.csv`) in the same folder.

### **Step 3: Prepare the UDF (C Code)**

1.  Open the `*.c` UDF file (e.g., `UDF_h_gen_NCA_1C.c`) in a text editor.

2.  **This is the most important step:** You MUST update the file path inside the UDF to match the location of your `.csv` file. Find the `fopen` command (likely inside a `DEFINE_INIT` macro) and provide the **full, absolute path** to your file.

    *Example C code to change:*

    ```c
    /* Original: */
    /* fp = fopen("heat_generation_NCA.csv", "r"); */

    /* Change to: */
    fp = fopen("C:\\Users\\YourName\\Desktop\\Project\\heat_generation_NCA.csv", "r");
    /* (Use double backslashes \\ for Windows paths) */
    ```

3.  Save the UDF file in your ANSYS working directory (where your case file is).

### **Step 4: Run the ANSYS Fluent Simulation**

1.  Open ANSYS Fluent and load your case file (e.g., `battery_model.cas.h5`). This file should contain your 3D mesh, material properties ($\rho$, $c$, $k$), and boundary conditions (e.g., convection to ambient).
2.  **Compile and Load the UDF:**
      * Go to `User-Defined` -\> `Functions` -\> `Compiled...`
      * Click `Add...`, select your `*.c` file, and click `Build`.
      * Wait for the console to report a successful build.
      * Click `Load`.
3.  **Hook the UDF:**
      * Go to `Cell Zone Conditions`.
      * Select the zone corresponding to the active battery material.
      * Click `Edit...` and go to the `Source Terms` tab.
      * Enable the `Energy` source term. Set the number of sources to `1`.
      * From the dropdown menu for the energy source, select your compiled UDF (e.g., `udf_heat_source::libudf`).
4.  **Run the Simulation:**
      * Set up your transient simulation parameters (e.g., time step size, number of time steps).
      * Initialize and run the calculation.
      * You can now post-process the results to visualize the temperature contours and find hotspots.

